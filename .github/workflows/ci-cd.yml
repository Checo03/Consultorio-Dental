name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./Backend
        run: npm ci
      
      - name: Run linter
        working-directory: ./Backend
        run: |
          if grep -q '"lint"' package.json; then
            npm run lint
          else
            echo "No linter configured, skipping..."
          fi
        continue-on-error: true
      
      - name: Run tests
        working-directory: ./Backend
        run: npm test
        continue-on-error: true

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: test-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./Backend
        run: npm ci
      
      - name: Build application
        working-directory: ./Backend
        run: |
          if grep -q '"build"' package.json; then
            npm run build
          else
            echo "No build script configured, skipping..."
          fi
      
      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: ./Backend
          retention-days: 7

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ConsultorioDental/package-lock.json
      
      - name: Install dependencies
        working-directory: ./ConsultorioDental
        run: npm ci
      
      - name: Validate HTML5
        working-directory: ./ConsultorioDental
        run: |
          echo "Validating HTML structure..."
          if [ -f "index.html" ]; then
            echo "index.html found - validation passed"
          else
            echo "Warning: index.html not found"
            exit 1
          fi
      
      - name: Build frontend
        working-directory: ./ConsultorioDental
        run: npm run build
      
      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ./ConsultorioDental/dist
          retention-days: 7

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ./backend-dist
      
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-dist
      
      - name: Prepare deployment
        run: |
          echo "Deployment artifacts ready"
          echo "Configure your deployment target below:"
          echo "- For Heroku: Add heroku/deploy-cloudrun@v0 action"
          echo "- For AWS: Add aws-actions/configure-aws-credentials@v4"
          echo "- For Azure: Add azure/webapps-deploy@v2"
          echo "- For custom server: Add SSH deployment steps"
          
      # Uncomment and configure based on your deployment target:
      # 
      # Example for SSH deployment:
      # - name: Deploy to server
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_KEY }}
      #     script: |
      #       cd /path/to/app
      #       git pull origin main
      #       npm install
      #       pm2 restart app
      #
      # Example for Heroku:
      # - name: Deploy to Heroku
      #   uses: akhileshns/heroku-deploy@v3.12.14
      #   with:
      #     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
      #     heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
      #     heroku_email: ${{ secrets.HEROKU_EMAIL }}
